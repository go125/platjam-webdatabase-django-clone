{% extends "base.html" %} 
{% block extraheader %}
<meta charset="UTF-8">
<title>Quick Start - Leaflet</title>
	
<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<style>
  html, body {
    height: 100%;
    margin: 0;
  }
  .leaflet-container {
    height: 400px;
    width: 600px;
    max-width: 100%;
    max-height: 100%;
  }
</style>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
{% endblock %}
{% block main %} 
<h2>
    店舗マップ
</h2>
<h2>投稿設定</h2>
<p>緯度：
	<input type="text" name="lat" id="lat" value="" />
</p>
<p>経度：
	<input type="text" name="lng" id="lng" value="" />
</p>
<p>説明：
	<input type="text" name="name" id="name" value="" />
</p>
<div class="container"><div id="map"></div></div>
<script>
var map = L.map('map');
var tileLayer = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png');
tileLayer.addTo(map);
// https://2ndart.hatenablog.com/entry/2021/04/28/112259 を利用
var place = JSON.parse('{{ data_json|safe }}');
//console.log(place);
iconMarkers = L.featureGroup();		// 全マーカーを画面内に収めるため
for (var i = 0; i < place.length; i++) {
	iconMarkers.addLayer( L.marker([place[i].lat, place[i].lng]).addTo(map).bindPopup(place[i].name) );
}
map.fitBounds(iconMarkers.getBounds());	// 全マーカーを画面内に収める
map.on('click', onMapClick);
var clickMarker = null;
function onMapClick(e) {
	if (clickMarker) {
		map.removeLayer(clickMarker);
	}
	var lat = e.latlng.lat;
	$("#lat").val(lat);
	var lng = e.latlng.lng;
	$("#lng").val(lng);
	// 地理院地図サーバから標高を求める
	// http://maps.gsi.go.jp/development/elevation_s.html
	var src = 'https://cyberjapandata2.gsi.go.jp/general/dem/scripts/getelevation.php?lon=' + lng + '&lat=' + lat;
	fetch(src)
	.then((response) => {
		return response.text();
	})
	.then((text) => {
		var results = JSON.parse(text);
		var popStr = '緯度：' + lat + '<br>経度：' + lng + '<br>標高：' + results.elevation + 'm';
		clickMarker = L.marker(e.latlng).on('click', onMarkerClick).addTo(map).bindPopup(popStr).openPopup();
	})
}
function onMarkerClick(e) {
	map.removeLayer(clickMarker);
}
</script>
{% endblock %}
